<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§çƒé¤Šæˆæ—¥è¨˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: manipulation;
        }
        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.75rem;
            border: 2px solid #a0a0a0;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out, color 0.5s;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            line-height: 1.75rem;
            white-space: nowrap; /* Prevent text from wrapping */
        }
        .action-button {
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s;
        }
        .action-button:active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15);
        }
        .action-button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .sub-menu {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        }
        .is-active {
            display: grid;
        }
    </style>
</head>
<body class="bg-blue-50 min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-lg mx-auto">
        <!-- Start Screen -->
        <div id="start-screen" class="bg-white rounded-2xl shadow-xl p-8 text-center space-y-6">
            <img src="./img/merak_sit.png" alt="åè‘—çš„å¤§çƒ" class="max-h-48 mx-auto object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/a0e0ff/333333?text=å¤§çƒ!&font=noto-sans-tc';">
            <h1 class="text-4xl font-bold text-gray-800">å¤§çƒé¤Šæˆæ—¥è¨˜</h1>
            <div class="text-left bg-gray-100 p-4 rounded-lg space-y-2">
                <h2 class="font-bold text-lg">éŠæˆ²èªªæ˜ï¼š</h2>
                <p class="text-gray-600">é€™é¡†çœ‹ä¼¼æ™®é€šçš„å¤§çƒï¼Œå…¶å¯¦æ˜¯æŸé¡†æ†æ˜Ÿçš„åŒ–èº«ã€‚åœ¨é™å®šå¤©æ•¸å…§èˆ‡å¤§çƒåŸ¹é¤Šæ„Ÿæƒ…ï¼Œæå‡å¥½æ„Ÿåº¦ä¾†è§£é–æ›´å¤šæœ‰è¶£çš„äº’å‹•å§ï¼</p>
            </div>
            <div class="space-y-3">
                <h3 class="font-bold text-xl">é¸æ“‡éŠæˆ²å¤©æ•¸ï¼š</h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                    <button data-days="5" class="start-game-btn action-button bg-purple-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-600">çŸ­æœŸ (5å¤©)</button>
                    <button data-days="10" class="start-game-btn action-button bg-purple-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-600">ä¸­æœŸ (10å¤©)</button>
                    <button data-days="20" class="start-game-btn action-button bg-purple-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-purple-600">é•·æœŸ (20å¤©)</button>
                </div>
            </div>
        </div>

        <!-- Game Screen (Initially hidden) -->
        <div id="game-screen" class="w-full bg-white rounded-2xl shadow-xl p-6 space-y-4 hidden">
            
            <div class="flex justify-between items-center text-gray-700 font-bold">
                <div id="day-counter" class="text-lg">ç¬¬ 1 / 10 å¤©</div>
                <div id="action-points-counter" class="text-lg">è¡Œå‹•åŠ›: 3</div>
            </div>

            <div class="bg-gray-100 rounded-lg flex justify-center items-center p-4 min-h-[250px]">
                <img id="merak-image" src="./img/merak_sit.png" alt="åè‘—çš„å¤§çƒ" class="max-h-56 object-contain" onerror="this.onerror=null;this.src='https://placehold.co/300x300/a0e0ff/333333?text=å¤§çƒ!&font=noto-sans-tc';">
            </div>
            <div id="message-box" class="text-center text-gray-600 font-medium min-h-[3.5rem] p-1 flex items-center justify-center"></div>

            <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-gray-700">å¥½æ„Ÿåº¦ â¤ï¸</span>
                        <span id="affinity-level-display" class="font-bold text-pink-500">LV. 1</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="affinity-bar" class="progress-bar bg-pink-400"></div>
                    </div>
                </div>
                <div>
                    <span class="font-bold text-gray-700">é£½é£Ÿåº¦</span>
                    <div class="progress-bar-container">
                        <div id="hunger-bar" class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <span class="font-bold text-gray-700">å¿ƒæƒ…</span>
                    <div class="progress-bar-container">
                        <div id="happiness-bar" class="progress-bar"></div>
                    </div>
                </div>
                <div>
                    <span class="font-bold text-gray-700">æ¸…æ½”åº¦</span>
                    <div class="progress-bar-container">
                        <div id="cleanliness-bar" class="progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-4 pt-2">
                <button id="feed-btn" class="action-button bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600">é¤µé£Ÿ</button>
                <button id="interact-btn" class="action-button bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-yellow-600">äº’å‹•</button>
                <button id="clean-btn" class="action-button bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600">æ¸…æ½”</button>
            </div>

            <div class="min-h-[80px]">
                <div id="feed-submenu" class="sub-menu gap-2"></div>
                <div id="interact-submenu" class="sub-menu gap-2"></div>
            </div>
            
            <button id="continue-btn" class="action-button w-full bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-indigo-600 hidden">ä¸‹ä¸€æ­¥ (Z)</button>
            <button id="next-day-btn" class="action-button w-full bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-gray-800 hidden">çµæŸé€™ä¸€å¤© (Z)</button>
        </div>

        <!-- End Screen (Initially hidden) -->
        <div id="end-screen" class="bg-white rounded-2xl shadow-xl p-8 text-center space-y-6 hidden">
            <img id="end-image" src="./img/merak_rocket.png" alt="çµå±€ç•«é¢" class="max-h-48 mx-auto object-contain" onerror="this.onerror=null;this.src='https://placehold.co/200x200/a0e0ff/333333?text=â¤ï¸&font=noto-sans-tc';">
            <h1 id="end-title" class="text-4xl font-bold text-gray-800">æ—…ç¨‹çµæŸ</h1>
            <p id="end-description" class="text-gray-600 text-lg"></p>
            <div class="text-center bg-gray-100 p-4 rounded-lg">
                <p class="text-gray-800 text-2xl font-bold">æœ€çµ‚å¥½æ„Ÿåº¦: <span id="final-affinity"></span></p>
            </div>
            <div class="text-left bg-gray-50 p-4 rounded-lg">
                 <h2 class="font-bold text-lg mb-2">èˆ‡å¤§çƒçš„å›æ†¶ï¼š</h2>
                 <div id="action-summary" class="text-gray-600 space-y-1"></div>
                 <p id="quest-summary" class="text-gray-800 font-bold mt-2"></p>
            </div>
            <button id="restart-game-btn" class="action-button w-full bg-purple-500 text-white font-bold py-4 px-4 rounded-lg shadow-md hover:bg-purple-600 text-xl">é‡æ–°é–‹å§‹</button>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Game Config ---
        const affinityLevels = [20, 35, 60, 100, 160, 240, 340, 480, 800, 1200]; 
        const FISHING_CATCHES = [
            { name: 'å°ä¸‘é­š', type: 'common', xp: 15, happiness: 15, message: 'é‡£åˆ°äº†ä¸€éš»æ´»æ½‘çš„å°ä¸‘é­šï¼' },
            { name: 'æ²³è±š', type: 'common', xp: 15, happiness: 15, message: 'é‡£åˆ°äº†ä¸€éš»æ°£å™—å™—çš„æ²³è±šï¼' },
            { name: 'å¤ªç©ºåƒåœ¾', type: 'junk', xp: 1, happiness: -10, message: 'é‡£åˆ°äº†ä¸€å¡Š...å¤ªç©ºåƒåœ¾...' },
            { name: 'çš‡å¸¶é­š', type: 'rare', xp: 80, happiness: 50, message: 'å¤©å•Šï¼æ˜¯å‚³èªªä¸­çš„çš‡å¸¶é­šï¼å¤§çƒçœ‹èµ·ä¾†è¶…ç´šèˆˆå¥®ï¼' }
        ];
        const DAILY_QUESTS = [
            { hint: "ä»Šå¤©å¤§çƒçœ‹èµ·ä¾†æœ‰é»å¯‚å¯...", actionKey: "hug", condition: (stats) => stats.happiness < 70 },
            { hint: "å¤§çƒçš„è‚šå­å¥½åƒåœ¨ç™¼å‡ºå¾®å¼±çš„è²éŸ¿...", actionKeys: ["almond", "chocolate", "onigiri", "pancake", "spring_roll", "zhongzi", "tangyuan"], condition: (stats) => stats.hunger < 70 },
            { hint: "å¤§çƒä»Šå¤©çœ‹èµ·ä¾†ç„¡ç²¾æ‰“é‡‡çš„...", actionKey: "sleep", condition: (stats) => true },
            { hint: "å¤§çƒçš„èº«é«”ä¼¼ä¹æœ‰é»é»¯æ·¡...", actionKey: "brush", condition: (stats) => stats.cleanliness < 70 },
            { hint: "å¤§çƒä»Šå¤©ä¼¼ä¹å¾ˆæƒ³å‘å¤–æ¢ç´¢...", actionKeys: ["fly", "surfing", "excavator"], condition: (stats) => true },
            { hint: "å¤§çƒä»Šå¤©çœ‹èµ·ä¾†ç†±å‘¼å‘¼çš„...", actionKey: "snowman", condition: (stats) => true },
            { hint: "å¤§çƒä»Šå¤©çœ‹èµ·ä¾†æœ‰é»å†·ï¼Œç¸®æˆäº†ä¸€åœ˜...", actionKeys: ["fire", "hug", "tangyuan"], condition: (stats) => true }
        ];

        // --- Game State ---
        let state = {};

        // --- DOM Elements ---
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameBtns = document.querySelectorAll('.start-game-btn');
        const restartGameBtn = document.getElementById('restart-game-btn');
        const dayCounter = document.getElementById('day-counter');
        const actionPointsCounter = document.getElementById('action-points-counter');
        const merakImage = document.getElementById('merak-image');
        const messageBox = document.getElementById('message-box');
        const affinityLevelDisplay = document.getElementById('affinity-level-display');
        const affinityBar = document.getElementById('affinity-bar');
        const hungerBar = document.getElementById('hunger-bar');
        const happinessBar = document.getElementById('happiness-bar');
        const cleanlinessBar = document.getElementById('cleanliness-bar');
        const feedBtn = document.getElementById('feed-btn');
        const interactBtn = document.getElementById('interact-btn');
        const cleanBtn = document.getElementById('clean-btn');
        const nextDayBtn = document.getElementById('next-day-btn');
        const continueBtn = document.getElementById('continue-btn');
        const feedSubmenu = document.getElementById('feed-submenu');
        const interactSubmenu = document.getElementById('interact-submenu');
        const finalAffinity = document.getElementById('final-affinity');
        const actionSummary = document.getElementById('action-summary');
        const questSummary = document.getElementById('quest-summary');
        const endImage = document.getElementById('end-image');
        const endTitle = document.getElementById('end-title');
        const endDescription = document.getElementById('end-description');

        // --- Action Definitions ---
        const actions = {
            // Normal Feed
            almond: { type: 'feed', img: 'merak_eat_nut.png', hunger: 10, happiness: 2, cleanliness: -2, xp: 5, message: 'å–€æ»‹å–€æ»‹ï¼', label: 'æä»', unlocksAt: 1 },
            chocolate: { type: 'feed', img: 'merak_chocolate.png', hunger: 15, happiness: 5, cleanliness: -5, xp: 8, message: 'å¤§çƒå–œæ­¡å·§å…‹åŠ›ï¼', label: 'å·§å…‹åŠ›', unlocksAt: 2 },
            onigiri: { type: 'feed', img: 'merak_onigiri.png', hunger: 22, happiness: 8, cleanliness: -8, xp: 15, message: 'åƒå®Œé£¯ç³°å¾Œï¼Œå¤§çƒè®Šæˆäº†ä¸‰è§’å½¢ï¼', label: 'é£¯ç³°', unlocksAt: 3 },
            pancake: { type: 'feed', img: 'merak_eat_pancake.png', hunger: 20, happiness: 5, cleanliness: -5, xp: 12, message: 'å¥½å¥½åƒçš„é¬†é¤…ï¼', label: 'é¬†é¤…', unlocksAt: 4 },
            spring_roll: { type: 'feed', img: 'merak_eat_spring_roll.png', hunger: 25, happiness: 10, cleanliness: -10, xp: 18, message: 'ä¾†è‡ªå®¶é„‰çš„æ‡·å¿µå¥½æ»‹å‘³ï¼', label: 'æ½¤é¤…', unlocksAt: 5 },
            zhongzi: { type: 'feed', img: 'merak_eat_zhongzi.png', hunger: 30, happiness: 10, cleanliness: -10, xp: 25, message: 'å¤§çƒç™¼å‡ºäº†æ»¿è¶³çš„æ ¸èåˆåæ‡‰è²ã€‚', label: 'ç²½å­', unlocksAt: 6 },
            tangyuan: { type: 'feed', img: 'merak_tangyuan.png', hunger: 35, happiness: 20, cleanliness: -15, xp: 30, message: 'æ³¡åœ¨æº«æš–çš„ç”œæ¹¯è£¡ï¼Œå¤§çƒèˆ’æœåœ°ç™¼å‡ºå¾®å…‰ã€‚', label: 'æ³¡æ¹¯åœ“', unlocksAt: 8 },
            // Special Feed
            book: { type: 'feed', img: 'merak_book.png', hunger: 5, happiness: -20, cleanliness: -5, xp: 1, message: 'æ›¸...æ›¸ä¸å¥½åƒ...', label: 'æ›¸', unlocksAt: 3 },
            disk: { type: 'feed', img: 'merak_eat_disk.png', hunger: 5, happiness: -25, cleanliness: -5, xp: 1, message: 'å¤§çƒçš„å…§éƒ¨æ§‹é€ ç™¼å‡ºäº†æ€ªè²ã€‚', label: 'ç¡¬ç¢Ÿ', unlocksAt: 4 },
            note: { type: 'feed', img: 'merak_eat_note.png', hunger: 2, happiness: -10, cleanliness: 0, xp: 1, message: 'é€™ä¸æ˜¯é£Ÿç‰©å§ï¼Ÿ', label: 'éŸ³ç¬¦', unlocksAt: 5 },
            gamepad: { type: 'feed', img: 'merak_eat_gamepad.png', hunger: 5, happiness: -30, cleanliness: -5, xp: 1, message: 'å˜å˜£è„†ï¼ä½†é€™ä¸æ˜¯é£Ÿç‰©...å¤§çƒçš„è¡¨æƒ…æœ‰é»å¾®å¦™ã€‚', label: 'éŠæˆ²æ‰‹æŠŠ', unlocksAt: 7 },
            medicine: { type: 'feed', img: 'merak_eat_medicine.png', hunger: -5, happiness: -15, cleanliness: 40, xp: 5, message: 'è—¥å¥½è‹¦...ä½†èº«é«”è®Šä¹¾æ·¨äº†ï¼', label: 'è—¥', unlocksAt: 6 },
            // Interact
            poke: { type: 'interact', img: 'merak_poke.png', hunger: 0, happiness: 3, cleanliness: 0, xp: 2, message: 'æˆ³äº†ä¸€ä¸‹ï¼Œå¤§çƒçš„è¡¨é¢æ³›èµ·äº†æ˜Ÿé›²èˆ¬çš„æ¼£æ¼ªã€‚', label: 'æˆ³æˆ³', unlocksAt: 1 },
            hug: { type: 'interact', img: 'merak_hug.png', hunger: -2, happiness: 15, cleanliness: -5, xp: 10, message: 'æ“æŠ±æ™‚ï¼Œèƒ½æ„Ÿè¦ºåˆ°ä¾†è‡ªæ†æ˜Ÿçš„æº«æš–ã€‚', label: 'æŠ±æŠ±', unlocksAt: 1 },
            sleep: { type: 'interact', img: 'merak_sleep.png', hunger: -5, happiness: 10, cleanliness: 5, xp: 8, message: 'è“‹ä¸Šæ£‰è¢«ï¼Œå¤§çƒç™¼å‡ºäº†å®‰ç©©çš„é¼¾è²ã€‚', label: 'ç¡è¦º', unlocksAt: 2 },
            fishing: { type: 'interact', img: 'merak_fishing.png', special: 'fishing', label: 'é‡£é­š', unlocksAt: 3 },
            fly: { type: 'interact', img: 'merak_fly.png', hunger: -10, happiness: 20, cleanliness: -5, xp: 22, message: 'ç”¨å‘†æ¯›åœ¨ç©ºä¸­é£›è¡Œï¼Œå°±åƒä¸€é¡†æ‚ å“‰çš„å½—æ˜Ÿã€‚', label: 'é£›è¡Œ', unlocksAt: 4 },
            banana: { type: 'interact', img: 'merak_banana.png', hunger: -5, happiness: 28, cleanliness: 0, xp: 35, message: 'é¦™è•‰...ï¼Ÿé›–ç„¶æœ‰é»å¥‡æ€ªï¼Œä½†å¤§çƒçœ‹èµ·ä¾†å¾ˆé–‹å¿ƒï¼', label: 'é¦™è•‰è£', unlocksAt: 4 },
            cow: { type: 'interact', img: 'merak_cow.png', hunger: -5, happiness: 25, cleanliness: 0, xp: 30, message: 'å“ï½ ç©¿ä¸Šç‰›ç‰›è£çš„å¤§çƒçœŸå¯æ„›ï¼', label: 'è£æ‰®', unlocksAt: 5 },
            surfing: { type: 'interact', special: 'chance', success: { img: 'merak_surfing.png', hunger: -15, happiness: 40, cleanliness: -10, xp: 50, message: 'æˆåŠŸé§•é¦­äº†æµªé ­ï¼å¤ªå¸¥äº†ï¼' }, failure: { img: 'merak_surfing2.png', hunger: -5, happiness: -10, cleanliness: -20, xp: 5, message: 'å™—é€šï¼æ‰é€²æµ·è£¡äº†...'}, label: 'è¡æµª', unlocksAt: 6 },
            excavator: { type: 'interact', img: 'merak_excavator.png', hunger: -15, happiness: 35, cleanliness: -20, xp: 40, message: 'å¤§çƒé–‹è‘—æŒ–åœŸæ©Ÿï¼Œå°‡ç…©æƒ±åƒå¤ªç©ºåƒåœ¾ä¸€æ¨£é€šé€šæ¸…é™¤ï¼', label: 'é–‹æŒ–åœŸæ©Ÿ', unlocksAt: 7 },
            fire: { type: 'interact', img: 'merak_fire.png', hunger: -5, happiness: 45, cleanliness: -5, xp: 60, message: 'åœ¨æº«æš–çš„çˆç«æ—ï¼Œå¤§çƒçš„æ ¸å¿ƒä¹Ÿè®Šå¾—æš–æ´‹æ´‹çš„ã€‚', label: 'çƒ¤ç«', unlocksAt: 8 },
            snowman: { type: 'interact', img: 'merak_snowman.png', hunger: -10, happiness: 50, cleanliness: 10, xp: 70, message: 'å¤§çƒè®Šæˆäº†é›ªäººï¼å†°å†°æ¶¼æ¶¼çš„å¥½åƒå¾ˆèˆ’æœã€‚', label: 'å †é›ªäºº', unlocksAt: 9 },
            wish: { type: 'interact', img: 'merak_rainbow.png', hunger: 0, happiness: 50, cleanliness: 50, xp: 100, message: 'ä½ èª å¿ƒåœ°å‘å¤§çƒè¨±é¡˜...ã€Œå¸Œæœ›å¯ä»¥æ°¸é è·Ÿå¤§çƒåœ¨ä¸€èµ·...ã€<br>å¤§çƒè½åˆ°äº†ä½ çš„å¿ƒè²ï¼Œæ•£ç™¼å‡ºæº«æš–çš„ä¸ƒå½©å…‰èŠ’ï¼Œå½·å½¿æ•´å€‹å®‡å®™éƒ½åœ¨ç‚ºä½ ç¥ç¦ã€‚', label: 'è¨±é¡˜', unlocksAt: 10 },
            // Clean
            brush: { type: 'clean', img: 'merak_brush.png', hunger: -2, happiness: 5, cleanliness: 40, xp: 8, message: 'å”°å”°å”°~ æº«æŸ”çš„å¹«å¤§çƒæ´—äº†æ¾¡<br>æ¸…æ½”éå¾Œï¼Œå¤§çƒè®Šå¾—æ›´åŠ é–ƒé–ƒç™¼å…‰äº†ï¼', label: 'æ¸…æ½”' },
        };

        function resetState() {
            state = {
                totalDays: 0,
                currentDay: 1,
                actionPoints: 3,
                isActionInProgress: false,
                isGameOver: false,
                affinityLevel: 1,
                affinityXP: 0,
                dailyQuest: null,
                completedQuests: 0,
                wasSick: false,
                stats: {
                    hunger: 80,
                    happiness: 80,
                    cleanliness: 80,
                },
                actionLog: {},
                dailyActionHistory: [],
            };
        }

        function startGame(days) {
            resetState();
            state.totalDays = days;
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            updateUI();
            setupSubmenus();
        }
        
        function addAffinityXP(amount) {
            if (amount <= 0 || state.affinityLevel > affinityLevels.length) return;
            state.affinityXP += amount;
            
            let xpForNextLevel = affinityLevels[state.affinityLevel - 1];
            while (state.affinityXP >= xpForNextLevel && state.affinityLevel <= affinityLevels.length) {
                state.affinityXP -= xpForNextLevel;
                state.affinityLevel++;
                xpForNextLevel = affinityLevels[state.affinityLevel - 1];
                messageBox.innerHTML = `å¥½æ„Ÿåº¦æå‡ï¼ LV.${state.affinityLevel}ï¼`;
                setTimeout(() => { if(messageBox.innerHTML.includes('å¥½æ„Ÿåº¦')) messageBox.innerHTML = ''; }, 2500);
            }
        }

        function performAction(actionKey) {
            if (state.isActionInProgress || state.actionPoints <= 0 || state.isGameOver) return;
            
            state.isActionInProgress = true;
            state.actionPoints--;

            let action = actions[actionKey];
            let outcome = action;
            let imageToDisplay = action.img;

            if (action.special === 'chance') {
                outcome = Math.random() < 0.5 ? action.success : action.failure;
                imageToDisplay = outcome.img;
            } else if (action.special === 'fishing') {
                const rand = Math.random();
                let catchResult;
                if (rand > 0.85) { // Rare (15%)
                    catchResult = FISHING_CATCHES.find(c => c.type === 'rare');
                } else if (rand > 0.70) { // Junk (15%)
                    catchResult = FISHING_CATCHES.find(c => c.type === 'junk');
                } else { // Common (70%)
                    const commonCatches = FISHING_CATCHES.filter(c => c.type === 'common');
                    catchResult = { ...action, ...commonCatches[Math.floor(Math.random() * commonCatches.length)] };
                }
                outcome = { ...action, ...catchResult };
                imageToDisplay = action.img;
            }

            let currentMessage = outcome.message;
            let xpGain = outcome.xp || 0;
            let happinessGain = outcome.happiness || 0;

            // Daily Quest Check
            const quest = state.dailyQuest;
            if (quest && (quest.actionKey === actionKey || (quest.actionKeys && quest.actionKeys.includes(actionKey)))) {
                xpGain = Math.round(xpGain * 1.5);
                let specialMessage = "å¤§çƒçœ‹èµ·ä¾†ç‰¹åˆ¥é–‹å¿ƒï¼Œä¼¼ä¹æ­£æƒ³é€™éº¼åšå‘¢ï¼";

                if (actionKey === 'medicine' && state.wasSick) {
                    specialMessage = "åƒè—¥ä¹‹å¾Œï¼Œå¤§çƒçœ‹èµ·ä¾†å¥½å¤šäº†ï¼";
                    state.stats.happiness = Math.min(100, state.stats.happiness + 20);
                    state.stats.hunger = Math.min(100, state.stats.hunger + 20);
                    state.wasSick = false;
                } else if (actionKey === 'hug') {
                    specialMessage = "ä½ çš„æ“æŠ±çµ¦äº†å¤§çƒæ»¿æ»¿çš„èƒ½é‡ï¼";
                }
                currentMessage = `${specialMessage}<br>(${outcome.message})`;

                state.dailyQuest = null; // Quest completed
                state.completedQuests++;
                if (state.completedQuests === 5) {
                    setTimeout(() => {
                        messageBox.innerHTML = "ä¸€å¼µå°å¡ç‰‡é£„äº†ä¸‹ä¾†...æ˜¯ã€Œå¤§çƒçš„æ„Ÿè¬ä¿¡ã€ï¼<br>ã€è¬è¬ä½ ç¸½æ˜¯çŸ¥é“æˆ‘åœ¨æƒ³ä»€éº¼ï¼Œè·Ÿä½ åœ¨ä¸€èµ·çš„æ¯ä¸€å¤©éƒ½åƒæ˜Ÿç©ºä¸€æ¨£é–ƒäº®ï¼ã€(å¥½æ„Ÿåº¦+100)";
                        addAffinityXP(100);
                        updateUI();
                    }, 2500);
                } else if (state.completedQuests === 10) {
                     setTimeout(() => {
                        messageBox.innerHTML = "åˆæ”¶åˆ°ä¸€å°æ„Ÿè¬ä¿¡ï¼<br>ã€è¬è¬ä½ ä¸€ç›´ä»¥ä¾†çš„æº«æŸ”ï¼Œæˆ‘å¥½åƒ...è¶Šä¾†è¶Šå–œæ­¡ä½ äº†ã€‚ã€(å¥½æ„Ÿåº¦+200)";
                        addAffinityXP(200);
                        updateUI();
                    }, 2500);
                }
            } else {
                const timesPerformedToday = state.dailyActionHistory.filter(a => a === actionKey).length;
                if (timesPerformedToday === 1) {
                    xpGain = Math.floor(xpGain / 2);
                    happinessGain = Math.floor(happinessGain / 2);
                    currentMessage = `å¤§çƒè¦ºå¾—æœ‰é»è†©äº†...`;
                } else if (timesPerformedToday >= 2) {
                    xpGain = 0;
                    happinessGain = -10;
                    currentMessage = `å¼ï¼ä¸è¦ä¸€ç›´åšä¸€æ¨£çš„äº‹ï¼`;
                }
            }
            
            addAffinityXP(xpGain);
            state.stats.hunger = Math.min(100, Math.max(0, state.stats.hunger + (outcome.hunger || 0)));
            state.stats.happiness = Math.min(100, Math.max(0, state.stats.happiness + happinessGain));
            state.stats.cleanliness = Math.min(100, Math.max(0, state.stats.cleanliness + (outcome.cleanliness || 0)));
            
            state.actionLog[action.label] = (state.actionLog[action.label] || 0) + 1;
            state.dailyActionHistory.push(actionKey);

            updateUI(currentMessage);
            merakImage.src = `./img/${imageToDisplay}`;
            merakImage.onerror = () => { merakImage.src = `https://placehold.co/300x300/a0e0ff/333333?text=${action.label}&font=noto-sans-tc`; };
            
            closeSubmenus();
            
            continueBtn.classList.remove('hidden');
            feedBtn.disabled = true;
            interactBtn.disabled = true;
            cleanBtn.disabled = true;
        }

        function continueAfterAction() {
            if (state.isGameOver) return;
            merakImage.src = './img/merak_sit.png';
            merakImage.onerror = () => { merakImage.src = 'https://placehold.co/300x300/a0e0ff/333333?text=å¤§çƒ!&font=noto-sans-tc'; };
            
            if (!messageBox.innerHTML.includes("1.") && !messageBox.innerHTML.includes("2.")) {
                 messageBox.innerHTML = '';
            }

            state.isActionInProgress = false;
            continueBtn.classList.add('hidden');
            
            if (!checkBadEnding()) {
                updateUI();
            }
        }
        
        function goToNextDay() {
            if (state.isGameOver) return;
            if (state.currentDay >= state.totalDays) {
                gameOver();
                return;
            }

            let dailyXPGain = Math.round((state.stats.happiness / 20) + (state.stats.hunger / 25) + (state.stats.cleanliness / 30) - 5);
            if (dailyXPGain > 0) {
                 addAffinityXP(dailyXPGain);
            }
            
            state.stats.hunger = Math.max(0, state.stats.hunger - 10);
            state.stats.happiness = Math.max(0, state.stats.happiness - 15);
            state.stats.cleanliness = Math.max(0, state.stats.cleanliness - 5);
            
            if (checkBadEnding()) return;

            state.currentDay++;
            state.actionPoints = 3;
            state.dailyActionHistory = [];
            state.dailyQuest = null;
            state.wasSick = false;

            let morningMessages = [];
            let hasBonusAP = false;

            // Sickness event
            if (state.affinityLevel >= actions.medicine.unlocksAt && Math.random() < 0.1) { // 10% chance to get sick
                state.stats.happiness = Math.max(0, state.stats.happiness - 20);
                state.stats.hunger = Math.max(0, state.stats.hunger - 20);
                state.dailyQuest = { hint: "å¤§çƒå¥½åƒç”Ÿç—…äº†...", actionKey: "medicine" };
                state.wasSick = true;
                morningMessages.push(state.dailyQuest.hint);
            } else {
                // Bonus action point chance
                if (state.affinityLevel >= 6 && Math.random() < 0.3) { 
                    state.actionPoints = 4;
                    morningMessages.push("å¤§çƒä»Šå¤©çœ‹èµ·ä¾†ç‰¹åˆ¥æœ‰æ´»åŠ›ï¼");
                    hasBonusAP = true;
                }
                // Daily quest chance
                if (Math.random() < 0.6) { // Increased from 0.4
                    const availableQuests = DAILY_QUESTS.filter(q => {
                        const actionKey = q.actionKey || q.actionKeys[0];
                        const isUnlocked = state.affinityLevel >= actions[actionKey].unlocksAt;
                        const meetsCondition = q.condition(state.stats);
                        const isNotTiredQuestOnEnergeticDay = !(q.actionKey === 'sleep' && hasBonusAP);
                        return isUnlocked && meetsCondition && isNotTiredQuestOnEnergeticDay;
                    });

                    if (availableQuests.length > 0) {
                        state.dailyQuest = availableQuests[Math.floor(Math.random() * availableQuests.length)];
                        morningMessages.push(state.dailyQuest.hint);
                    }
                }
            }

            if (morningMessages.length > 0) {
                messageBox.innerHTML = morningMessages.map((msg, index) => `${morningMessages.length > 1 ? (index + 1) + '. ' : ''}${msg}`).join('<br>');
            } else {
                messageBox.innerHTML = '';
            }
            
            updateUI();
            setupSubmenus();
        }

        function checkBadEnding() {
            if (state.stats.hunger <= 0) {
                gameOver("bad", "å› ç‚ºå¤ªé¤“äº†ï¼Œå¤§çƒé›¢å®¶å‡ºèµ°äº†...");
                return true;
            }
            if (state.stats.happiness <= 0) {
                gameOver("bad", "å› ç‚ºå¤ªé›£éäº†ï¼Œå¤§çƒé›¢å®¶å‡ºèµ°äº†...");
                return true;
            }
            if (state.stats.cleanliness <= 0) {
                gameOver("bad", "å› ç‚ºå¤ªé«’äº†ï¼Œå¤§çƒé›¢å®¶å‡ºèµ°äº†...");
                return true;
            }
            return false;
        }

        function gameOver(endingType = "normal", message = "") {
            if (state.isGameOver) return;
            state.isGameOver = true;

            gameScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalAffinity.textContent = `LV. ${state.affinityLevel}`;

            if (endingType === "bad") {
                endTitle.textContent = "æ—…ç¨‹æå‰çµæŸ";
                endDescription.textContent = message + " å¤§çƒæ±ºå®šå»å°‹æ‰¾å…¶ä»–å¯ä»¥å–„å¾…å¥¹çš„äººã€‚";
                endImage.src = './img/merak_board_false.png'; 
                endImage.onerror = () => { endImage.src = 'https://placehold.co/200x200/aaaaaa/333333?text=...&font=noto-sans-tc'; };
                endImage.className = "max-h-48 mx-auto object-contain";
            } else if (state.affinityLevel >= 9 && state.actionLog['è¨±é¡˜']) { // Perfect Ending
                endTitle.textContent = "å¶„æ–°çš„æ—©æ™¨";
                endDescription.textContent = "éš”å¤©é†’ä¾†ï¼Œä½ ç™¼ç¾èº«æ—çš„å¤§çƒä¸è¦‹äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä½å¯æ„›çš„è—é«®å°‘å¥³ã€‚å¥¹å¾®ç¬‘è‘—èªªï¼šã€Œè¬è¬ä½ ä¸€ç›´ä»¥ä¾†çš„ç…§é¡§ï¼Œå¾ä»Šä»¥å¾Œï¼Œä¹Ÿè«‹å¤šæŒ‡æ•™å›‰ï¼ã€å¾é‚£å¤©èµ·ï¼Œä½ å€‘ä¸€èµ·ç”Ÿæ´»ï¼Œå¶çˆ¾å¥¹æœƒè®Šå›å¤§çƒçš„æ¨£å­æ’’å¬Œï¼Œä½ å€‘ä¸€èµ·çœ‹æ˜Ÿæ˜Ÿã€ä¸€èµ·åƒé£¯ã€ä¸€èµ·å‰µé€ äº†ç„¡æ•¸é–ƒé–ƒç™¼å…‰çš„å›æ†¶ã€‚";
                endImage.src = './img/merak_morning.png';
                endImage.onerror = () => { endImage.src = 'https://placehold.co/480x270/a0e0ff/333333?text=å®Œç¾çµå±€&font=noto-sans-tc'; };
                endImage.className = "w-full rounded-lg object-contain";
            } else { // Normal Ending
                endTitle.textContent = "æ—…ç¨‹çµæŸ";
                endDescription.textContent = "åœ¨ç´„å®šçš„æœ€å¾Œä¸€å¤©ï¼Œå¤§çƒå‘ä½ é“åˆ¥ï¼Œä¸¦æ­ä¸Šäº†ä¸€è‰˜å°å°çš„ç«ç®­ã€‚ä½ çœ‹è‘—ç«ç®­ç·©ç·©å‡ç©ºï¼Œæ¶ˆå¤±åœ¨å›å¤§ç†Šæ˜Ÿåº§çš„è·¯ä¸Šã€‚";
                endImage.src = './img/merak_rocket.png';
                endImage.onerror = () => { endImage.src = 'https://placehold.co/200x200/a0e0ff/333333?text=æ™®é€šçµå±€&font=noto-sans-tc'; };
                endImage.className = "max-h-48 mx-auto object-contain";
            }
            
            actionSummary.innerHTML = '';
            if (Object.keys(state.actionLog).length === 0) {
                actionSummary.innerHTML = '<p>é€™æ¬¡æ²’æœ‰è·Ÿå¤§çƒç•™ä¸‹ä»»ä½•å›æ†¶...</p>';
            } else {
                 for (const [action, count] of Object.entries(state.actionLog)) {
                    const p = document.createElement('p');
                    p.textContent = `ãƒ»${action}ï¼š${count} æ¬¡`;
                    actionSummary.appendChild(p);
                }
            }
            questSummary.textContent = `å®Œæˆæ¯æ—¥å¿ƒé¡˜ï¼š${state.completedQuests} æ¬¡`;
        }
        
        function updateUI(message = '') {
            dayCounter.textContent = `ç¬¬ ${state.currentDay} / ${state.totalDays} å¤©`;
            actionPointsCounter.textContent = `è¡Œå‹•åŠ›: ${state.actionPoints}`;
            if(message) messageBox.innerHTML = message;

            affinityLevelDisplay.textContent = `LV. ${state.affinityLevel}`;
            const isMaxLevel = state.affinityLevel > affinityLevels.length;
            if (isMaxLevel) {
                updateBar(affinityBar, 1, 1, `MAX`);
            } else {
                const xpForNextLevel = affinityLevels[state.affinityLevel - 1];
                updateBar(affinityBar, state.affinityXP, xpForNextLevel, `XP: ${state.affinityXP} / ${xpForNextLevel}`);
            }
            affinityBar.style.backgroundColor = '#f472b6';
            
            updateBar(hungerBar, state.stats.hunger, 100, `${state.stats.hunger}%`);
            updateBar(happinessBar, state.stats.happiness, 100, `${state.stats.happiness}%`);
            updateBar(cleanlinessBar, state.stats.cleanliness, 100, `${state.stats.cleanliness}%`);
            
            const canAct = state.actionPoints > 0 && !state.isActionInProgress;
            feedBtn.disabled = !canAct;
            interactBtn.disabled = !canAct;
            cleanBtn.disabled = !canAct;
            
            if (state.actionPoints <= 0 && !state.isActionInProgress) {
                nextDayBtn.classList.remove('hidden');
                closeSubmenus();
            } else {
                nextDayBtn.classList.add('hidden');
            }
        }

        function updateBar(barElement, value, maxValue = 100, text) {
            const percentage = Math.min(100, Math.max(0, (value / maxValue) * 100));
            barElement.style.width = `${percentage}%`;
            barElement.textContent = text;

            if (percentage < 45 && percentage > 0) {
                barElement.style.color = '#374151'; // text-gray-700
                barElement.style.textAlign = 'left';
                barElement.style.paddingLeft = '10px';
            } else {
                barElement.style.color = 'white';
                barElement.style.textAlign = 'center';
                barElement.style.paddingLeft = '0';
            }
            
            if (barElement.id.includes('affinity')) return;

            if (percentage > 60) barElement.style.backgroundColor = '#4ade80';
            else if (percentage > 30) barElement.style.backgroundColor = '#facc15';
            else barElement.style.backgroundColor = '#f87171';
        }

        function setupSubmenus() {
            feedSubmenu.innerHTML = '';
            interactSubmenu.innerHTML = '';

            for (const key in actions) {
                const action = actions[key];
                if (!action.label) continue;
                
                const isUnlocked = state.affinityLevel >= action.unlocksAt;
                
                const button = document.createElement('button');
                button.textContent = isUnlocked ? action.label : `ğŸ”’ LV.${action.unlocksAt}`;
                button.onclick = () => performAction(key);
                button.disabled = !isUnlocked;

                let colorClass = 'bg-gray-200 text-gray-400';
                if (isUnlocked) {
                    if (action.type === 'feed') colorClass = 'bg-green-200 text-green-800';
                    if (action.type === 'interact') colorClass = 'bg-yellow-200 text-yellow-800';
                }
                
                button.className = `action-button ${colorClass} p-2 rounded-md text-sm`;
                if (action.type === 'feed') feedSubmenu.appendChild(button);
                else if (action.type === 'interact') interactSubmenu.appendChild(button);
            }
        }
        
        function closeSubmenus() {
            feedSubmenu.classList.remove('is-active');
            interactSubmenu.classList.remove('is-active');
        }

        function initializeApp() {
            gameScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
        }

        // --- Event Listeners ---
        startGameBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const days = parseInt(btn.getAttribute('data-days'));
                startGame(days);
            });
        });
        restartGameBtn.addEventListener('click', initializeApp);
        nextDayBtn.addEventListener('click', goToNextDay);
        continueBtn.addEventListener('click', continueAfterAction);
        document.addEventListener('keyup', (e) => {
            if (e.key.toLowerCase() === 'z') {
                if (!continueBtn.classList.contains('hidden')) {
                    continueAfterAction();
                } else if (!nextDayBtn.classList.contains('hidden')) {
                    goToNextDay();
                }
            }
        });
        feedBtn.addEventListener('click', () => {
            feedSubmenu.classList.toggle('is-active');
            interactSubmenu.classList.remove('is-active');
        });
        interactBtn.addEventListener('click', () => {
            interactSubmenu.classList.toggle('is-active');
            feedSubmenu.classList.remove('is-active');
        });
        cleanBtn.addEventListener('click', () => performAction('brush'));

        // --- Initial Load ---
        initializeApp();
    });
    </script>
</body>
</html>
